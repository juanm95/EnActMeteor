<template name="Page_Template">

  <body>
    <script>
    var unlimitedPageAccessToken = 'EAASYhfO68sgBANUSnleUD0JXcFMU3KwyrpBI96BQG9LKuXGTIWcWe4lZBxjlcOYQjYdZCPGWaMkg94o2REH22YHPhvnJZCTUsvPpbnhPyFlelijZAK42c5X1m230bkpQ2OKMz6MHYZAmc9e3vs5a1IuxKmQC24HyV1CB2Eqy7LAZDZD'

      function postsToDatabase() {
        FB.api('/108247265894675/feed?fields=message, object_id, permalink_url, created_time, shares, updated_time',
          'GET', {
            access_token: unlimitedPageAccessToken
          },
          function (response) {
            if (response && !response.error) {
              for (i = 0; i < response.data.length; i++) {
                Issues.update({
                  _id: response.data[i].id
                }, {
                  $set: {
                    message: response.data[i].message,
                    object_id: response.data[i].object_id,
                    url: response.data[i].permalink_url,
                    created_time: response.data[i].created_time,
                    shares: response.data[i].shares,
                    last_interaction_time: response.data[i].updated_time,
                    comments: []
                  },
                  $setOnInsert: {
                    tags: ["open"],
                    isCached: false
                  }
                }, {
                  upsert: true
                });
              }
              getCommentsOfEachPost();
            }
          }
        );
      }

      function getCommentsOfEachPost() {
        Issues.find({}).forEach(
          function (post) {
            var id = post._id
            FB.api(
              '/' + id + '/comments', 'GET', {
                access_token: unlimitedPageAccessToken,
                summary: 'true',
                order: 'reverse_chronological'
              },
              function (response) {
                if (response && !response.error) {
                  for (i = 0; i < response.data.length; i++) {
                    var message = response.data[i].message
                    Issues.update({
                      _id: id
                    }, {
                      $addToSet: {
                        comments: message
                      }
                    })
                  }
                }
              }
            );
          }
        )
      }

    // This function is called when someone finishes with the Login
    // Button.  See the onlogin handler attached to it in the sample
    // code below.
    // function checkLoginState() {
    //   FB.getLoginStatus(function(response) {
    //     statusChangeCallback(response);
    //   });
    // }

      window.fbAsyncInit = function () {
        FB.init({
          appId: '1293600994030280',
          cookie: true, // enable cookies to allow the server to access 
          // the session
          xfbml: true, // parse social plugins on this page
          version: 'v2.5' // use graph api version 2.5
        })
        postsToDatabase()
        getCommentsOfEachPost()
      };

      // Load the SDK asynchronously
      (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
        console.log("loaded sdk at " + new Date());
      }(document, 'script', 'facebook-jssdk'));

      //------------- SAVING HTML OF POSTS --------------------//

      var innerHTMLs = {} // This is a map from id (in our database) to the most recent innerhtml.
      function saveInnerHTMLs() { // Goes through our innerHTMLs and updates them in the database
        Object.keys(innerHTMLs).forEach(function (key) {
          if (innerHTMLs[key] !== "") {
            Issues.update({
              _id: key
            }, {
              $set: {
                innerHTML: innerHTMLs[key],
                isCached: true
              }
            }, {
              upsert: true
            });
          }
        });
        $("#status").html("New content has been saved!");
      }
      var lastChangeTimeoutID = "";
      // This keeps track of changes within fb-post-containers and saves the new contents to our database.
      // This uses mutation observers which you can learn more about here: https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver
      var observer = new MutationObserver(
        function (mutations) {
          mutations.forEach(
            function (mutation) {
              if (mutation.target.id !== "fb-posts" && mutation.target.localName === "div" && mutation.target.classList.length > 1 && mutation.target.classList[1] === "new-post") { // Ignores alerts at the iframe and the all-post level.
                console.log(mutation);
                $("#status").html("Detected new content. Saving new content...");
                var postId = mutation.target.id;
                innerHTMLs[postId] = mutation.target.innerHTML;
                window.clearTimeout(lastChangeTimeoutID); // each time something gets changed in our html, we reset this timer. It takes 20 seconds to assume its safe to save.
                lastChangeTimeoutID = window.setTimeout(saveInnerHTMLs, 20000);
              }
            }
          );
        }
      );

      var config = {
        attributes: true,
        childList: true,
        characterData: true,
        subtree: true
      };
      observer.observe(document.getElementById("fb-posts"), config);
      //------------- SAVING HTML OF POSTS END --------------------//
    </script>
    <div class="container">
      <header>
        <h1>EnAct</h1>
        <div class="login">{{> loginButtons}}</div>
        <h2>Open Issues: {{openIssuesCount}}</h2>
        
        <div class="tag-list">
          {{#each alltags}}
            <label class="checkBoxClass">
              <input type="checkbox" name={{this}}> {{this}}
            </label>
          {{/each}}
       </div>

        <div id="status">
        </div>
      </header>
      <!-- In order to test the saving of innerHTML and then displaying that, first uncomment the old code to gather the innerHTML, then once the innerHTML has been added to the database (check it in meteor mongo), come back here, and comment it out. -->
      <div class="all-posts-container" id="fb-posts">
        {{#each posts}}
        <div class="fb-post-container">
          <div class="fb-post">
            {{#if isCached}} {{{innerHTML}}} (This content has been cached) {{else}}
            <div class="fb-post new-post" data-href="{{url}}" data-width="500" data-show-text="true" id="{{_id}}">
            </div>
            (This content has not been cached) {{/if}}
          </div>

          <div class="extra-post-info">
            <div class="comments">
              {{#each comments}}
              <li class="comment">{{this}}</li>
              {{/each}}
            </div>
            <div class="issue-tag-list">
              {{#each tags}}
                <button type="button" disabled class="issue-tag">{{this}}</button>
              {{/each}}
            </div>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
  </body>
</template>